// Prisma schema for personal-banking-app with Plaid support
// Models: User, Item (Plaid connection), Account, Transaction

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  name       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  items      Item[]
  accounts   Account[]
}

// Plaid Item represents a bank connection (an Item in Plaid)
model Item {
  id            Int       @id @default(autoincrement())
  plaidItemId   String    @unique
  userId        Int
  accessToken   String
  institutionId String?
  institutionName String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts      Account[]

  @@index([userId])
}

model Account {
  id              Int        @id @default(autoincrement())
  userId          Int        //owner user id (denormalized for simpler queries)
  itemId          Int        //the Plaid Item this account belongs to
  plaidAccountId  String?    @unique
  name            String
  officialName    String?    //given by plaid
  mask            String?    //last 4 digits of the account/card number
  institutionId   String?
  currency        String?
  balance         Decimal    @db.Decimal(12, 2) @default("0.00")
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  item            Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@index([userId])
  @@index([itemId])
}

model Transaction {
  id                 Int       @id @default(autoincrement())
  accountId          Int
  plaidTransactionId String?   @unique
  amount             Decimal   @db.Decimal(12, 2)
  pending            Boolean   @default(false)
  merchantName       String?
  category           String?
  // Application-mapped category (e.g. "Transportation", "Groceries")
  appCategory        String?
  // Plaid category id (e.g. "13005000") for stable grouping
  plaidCategoryId    String?
  // Full Plaid category hierarchy as JSON (e.g. ["Food and Drink","Restaurants"])
  categoryHierarchy  Json?
  isoCurrencyCode    String?
  date               DateTime
  authorizedDate     DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  account            Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([date])
}

// Map Plaid category identifiers or top-level category names to app category labels
model CategoryMap {
  id            Int     @id @default(autoincrement())
  plaidCategory String  @unique
  appCategory   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Records accounts explicitly removed by the user so sync doesn't re-create them
model RemovedPlaidAccount {
  id             Int      @id @default(autoincrement())
  plaidAccountId String
  itemId         Int?
  userId         Int?
  reason         String?
  removedAt      DateTime @default(now())

  @@index([plaidAccountId])
  @@index([itemId])
}
